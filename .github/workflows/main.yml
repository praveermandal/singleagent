name: Phoenix V63 RDP Sim

on:
  workflow_dispatch:      # Manual trigger button
  repository_dispatch:    # Loop trigger
    types: [restart_bot]
  schedule:
    - cron: '0 */6 * * *' # Backup triggers every 6 hours

permissions:
  actions: write
  contents: read

jobs:
  run-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Max run time (6 hours)

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install System Dependencies (XVFB & Chrome)
      run: |
        sudo apt-get update
        # XVFB is required for the Virtual Display
        # Google Chrome Stable is required for the browser
        sudo apt-get install -y xvfb google-chrome-stable

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python Libraries
      run: |
        # undetected-chromedriver: Hides the bot status
        # pyvirtualdisplay: Creates the fake screen
        pip install selenium undetected-chromedriver pyvirtualdisplay

    - name: üñ•Ô∏è Run V63 RDP Simulator
      id: bot_process
      continue-on-error: true  # Ensures the restart step runs even if the bot crashes
      env:
        INSTA_COOKIE: ${{ secrets.INSTA_COOKIE }}
        TARGET_THREAD_ID: ${{ secrets.TARGET_THREAD_ID }}
        MESSAGES: ${{ secrets.MESSAGES }}
      run: |
        # Run the script
        python main.py

    - name: üîÑ The Lazarus Protocol (Auto-Restart)
      if: always()  # Runs every time, success or fail
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "‚ö†Ô∏è Bot finished. Calculating safety delay..."
        
        # üõ°Ô∏è SAFETY DELAY: Wait 5 to 15 minutes (300 to 900 seconds)
        # This breaks the "continuous uptime" pattern that flags bots.
        DELAY=$(( ( RANDOM % 600 ) + 300 ))
        echo "üí§ Sleeping for $DELAY seconds..."
        sleep $DELAY
        
        # üîÑ DYNAMIC RESTART (Filename Independent)
        # This grabs the ID of the current workflow and restarts it.
        # It works regardless of whether the file is named main.yml or anything else.
        echo "üîÑ Fetching current workflow ID..."
        WORKFLOW_ID=$(gh run view ${{ github.run_id }} --json workflowDatabaseId --jq '.workflowDatabaseId')
        
        echo "üöÄ Restarting Workflow ID: $WORKFLOW_ID"
        gh workflow run $WORKFLOW_ID

    - name: üì∏ Upload Debug Evidence (Only on Failure)
      if: failure() || steps.bot_process.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: crash-screenshots
        path: "*.png"
